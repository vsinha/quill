<!DOCTYPE html>
<html>
<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
<style>
  body {
    margin: 0px;
    width: 100%;
    height: 100%;
  }
  canvas#canvas {
    /* cursor: none; */ /* this hides the cursor while it's in the canvas */
    position: absolute;
    top: 0px;
    left: 0px;
  }
  object {
    width: 0px; /* hide */
    height: 0px; /* hide */
  }
  .button {
    height: 50px;
    width: 50px;
    position: absolute;
    top: 10px;
    font-family: sans-serif;
    font-size: 24px;
    background: rgba(50, 50, 50, 0.9);
    color: white;
    cursor: pointer;
    border-radius: 2px;
    line-height: 50px;
    text-align: center;
  }
  .button img {
    margin-top: 13px;
  }
  #mode {
    left: 10px;
  }
  #clear {
    left: 10px;
  }
  #save {
    left: 80px;
  }
  #cursor {
    left: 150px;
  }
  #texture {
    left: 290px;
  }
  .noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }
</style>
</head>

<body>
  <script src="http://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>

  <!-- Canvas -->
  <canvas id="canvas" class="noselect"></canvas>
  <!-- Buttons -->
  <!--<div id="mode" class="button noselect">Mode</div>-->
  <div id="clear" class="button noselect"><img src="img/paper-24.png"/></div>
  <div id="save" class="button noselect"><img src="img/save-24.png"/></div>
  <div id="cursor" class="button noselect"><img id="cursor-icon" src="img/cursor-24-75.png"/></div>
  <!--<div id="texture" class="button noselect">Texturing</div>-->
  <!-- Wacom plugin -->
  <!-- <object id="wtPlugin" type="application/x-wacomtabletplugin">
    <param name="onload" value="pluginLoaded"/>
  </object> -->

  <script>
     // the URL of the WAMP Router (Crossbar.io)
     //
     var wsuri;
     if (document.location.origin == "file://") {
        wsuri = "ws://127.0.0.1:8080/ws";
     } else {
        wsuri = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" +
                    document.location.host + "/ws";
     }
     // the WAMP connection to the Router
     //
     var connection = new autobahn.Connection({
        url: wsuri,
        realm: "realm1"
     });
     // timers
     //
     var t1, t2;
     // fired when connection is established and session attached
     //
     connection.onopen = function (session, details) {
        console.log("Connected");
        // SUBSCRIBE to a topic and receive events
        //
        function on_counter (args) {
           var counter = args[0];
           console.log("on_counter() event received with counter " + counter);
        }
        session.subscribe('com.quill.testClientCounter', on_counter).then(
           function (sub) {
              console.log('subscribed to topic');
           },
           function (err) {
              console.log('failed to subscribe to topic', err);
           }
        );
        // PUBLISH an event every second
        //
        var serverCounter = 0;
        t1 = setInterval(function () {
           session.publish('com.quill.testServerCounter', ['Hello from the client: ' + serverCounter]);
           console.log("published to topic 'com.quill.testServerCounter' value: " + serverCounter);
           serverCounter += 1;
        }, 1000);
     };
     // fired when connection was lost (or could not be established)
     //
     connection.onclose = function (reason, details) {
        console.log("Connection lost: " + reason);
        if (t1) {
           clearInterval(t1);
           t1 = null;
        }
        if (t2) {
           clearInterval(t2);
           t2 = null;
        }
     }
     // now actually open the connection
     //
     connection.open();
  </script>

  
</body>

<script type='text/javascript' src="ploma.js"></script>
<script type="text/javascript">
  "use strict";

  // TEST
  var elapsed;

  // DOM
  var canvas;
  var mode;
  var save;
  var clear;
  var cursor;
  var texture;
  var plugin;
  var penAPI;
  var extendStroke;

  // State
  var sampling = 2;
  var ploma = null;
  var w;// = 1300;
  var h;// = 1000;
  var isDrawing = false;

  // Red Pixel
  var r = new Uint8ClampedArray(16);
  var rid;
  r[0] = 255;
  r[3] = 255;
  r[4] = 255;
  r[7] = 255;
  r[8] = 255;
  r[11] = 255;
  r[12] = 255;
  r[15] = 255;

  /////////////
  // ONLOAD
  /////////////
  window.onload = function() {

    // load DOM elements
    canvas = document.getElementById('canvas');
    canvas.setAttribute('width', window.innerWidth);
    canvas.setAttribute('height', window.innerHeight);
    mode = document.getElementById('mode');
    save = document.getElementById('save');
    clear = document.getElementById('clear');
    cursor = document.getElementById('cursor');
    texture = document.getElementById('texture');
    plugin = document.getElementById('wtPlugin');
    // penAPI = plugin.penAPI;
    //mode.innerHTML = sampling;
    //texture.innerHTML = "T";

    // populate red pixel
    rid = canvas.getContext('2d').createImageData(2, 2);
    rid.data.set(r);

    // load Ploma onto canvas and clear it
    ploma = new Ploma(canvas);
    ploma.clear();
    extendStroke = ploma.extendStroke;

    ////////////
    // BUTTONS
    ////////////
    /*mode.onclick = function(e) {
      sampling = (sampling === 2) ? 0 : sampling + 1;
      ploma.setSample(sampling);
      mode.innerHTML = sampling; 
    }*/
    save.onclick = function(e) {
      window.open(canvas.toDataURL());
    }
    clear.onclick = function(e) {
      ploma.clear();
    }
    cursor.onclick = function(e) {
      // TODO: UPDATE CHECKBOX OR IMAGE ON BUTTON
      if(canvas.style.cursor === 'none') {
        document.getElementById('cursor-icon').setAttribute('src', 'img/cursor-24.png');
        canvas.style.cursor = 'crosshair';
      } else {
        document.getElementById('cursor-icon').setAttribute('src', 'img/cursor-24-75.png');
        canvas.style.cursor = 'none';
      }
    }
    /*texture.onclick = function(e) {
      ploma.toggleTexture();
      if (texture.innerHTML === "T") {
        texture.innerHTML = "N";
      } else {
        texture.innerHTML = "T";
      }
    }*/

    ////////////
    // RESIZE
    ////////////
    window.onresize = function(e) {
      ploma.resize(window.innerWidth, window.innerHeight);
    }

    // bind device input events
    /*if(window.PointerEvent) {
      ///////////////////////////////////
      // POINTER EVENT
      ///////////////////////////////////
      canvas.onpointerdown = function(e) {
        ploma.beginStroke(
          e.clientX,
          e.clientY,
          e.pressure
        );
        isDrawing = true;
      }
      canvas.onpointermove = function(e) {
        if (!isDrawing) return;
        ploma.extendStroke(
          e.clientX,
          e.clientY,
          e.pressure
        );
      }
      canvas.onpointerup = function(e) {
        ploma.endStroke(
          e.clientX,
          e.clientY,
          e.pressure
        );
        isDrawing = false;
      }
    } else {*/
      ///////////////////////////////////
      // MOUSE EVENT
      ///////////////////////////////////
      canvas.onmousedown = function(e) {
        isDrawing = true;
        if (sampling === 0) return;
        ploma.beginStroke(
          e.clientX,
          e.clientY,
          0.9
        );
      }
      canvas.onmousemove = function(e) {
        if (!isDrawing) return;
        //elapsed = Date.now();
        if (sampling === 0) {
          //console.log(Date.now() - elapsed);
          canvas.getContext('2d').putImageData(
            rid,
            e.clientX,
            e.clientY,
            0,
            0,
            2,
            2
          );
          return;
        }
        ploma.extendStroke(
          e.clientX,
          e.clientY,
          0.9
        );
      }
      canvas.onmouseup = function(e) {
        isDrawing = false;
        if (sampling === 0) return;
        ploma.endStroke(
          e.clientX,
          e.clientY,
          0.9
        );
      }
    //} 
  }

</script>

</html>
